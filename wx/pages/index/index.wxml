<view class="page">
  <view class="bg" style="background-image: url({{officeBgUrl}});"></view>
  <view class="bg-overlay"></view>

  <view wx:if="{{scene === 'start'}}" class="scene start fade-in">
    <text class="title pixel-zh-title">æ‘¸é±¼è°·ç‰©è¯­</text>
    <text class="subtitle">Office Valley</text>
    <button class="start-btn" bindtap="goSelect">
      <text class="btn-icon">â–¶ï¸</text>
      <text>START GAME</text>
    </button>
  </view>

  <view wx:if="{{scene === 'select'}}" class="scene select fade-in">
    <view class="select-header">
      <button class="back-btn" bindtap="goStart">â† BACK</button>
      <text class="select-title">é…ç½®å¯¹å±€</text>
      <view class="header-spacer"></view>
    </view>

    <view class="select-body">
      <view class="select-card red">
        <text class="card-title red">BOSS</text>
        <view class="card-list">
          <view
            wx:for="{{bossSkills}}"
            wx:key="id"
            class="card-item {{selected.boss[0] === item.id ? 'active red' : ''}}"
            data-role="boss"
            data-id="{{item.id}}"
            bindtap="onToggleSkill"
          >
            <view class="item-icon">{{item.iconEmoji}}</view>
            <view class="item-info">
              <text class="item-name">{{item.name}}</text>
              <text class="item-desc">{{item.desc}}</text>
            </view>
            <view wx:if="{{selected.boss[0] === item.id}}" class="item-dot red"></view>
          </view>
        </view>
      </view>

      <view class="versus">
        <text class="versus-icon {{selected.emp.length ? 'bounce' : ''}}">âš”ï¸</text>
      </view>

      <view class="select-card blue">
        <text class="card-title blue">YOU</text>
        <view wx:if="{{isEmpLocked}}" class="locked">
          <text class="locked-icon">ğŸ”’</text>
          <text class="locked-text">Locked</text>
        </view>
        <view wx:else class="card-list">
          <view
            wx:for="{{availableEmpSkills}}"
            wx:key="id"
            class="card-item {{selected.emp[0] === item.id ? 'active blue' : ''}}"
            data-role="emp"
            data-id="{{item.id}}"
            bindtap="onToggleSkill"
          >
            <view class="item-icon">{{item.iconEmoji}}</view>
            <view class="item-info">
              <text class="item-name">{{item.name}}</text>
              <text class="item-desc">{{item.desc}}</text>
            </view>
            <view wx:if="{{selected.emp[0] === item.id}}" class="item-dot blue"></view>
          </view>
        </view>
      </view>
    </view>

    <view class="select-footer">
      <button
        class="enter-btn"
        bindtap="goBattle"
        disabled="{{selected.emp.length === 0}}"
      >
        <text class="btn-icon">âš”ï¸</text>
        <text>ENTER OFFICE</text>
      </button>
    </view>
  </view>

  <view wx:if="{{scene === 'battle'}}" class="scene battle">
    <view class="battle-header">
      <view class="battle-side">
        <view class="avatar {{isBossDefeated ? 'avatar-dim' : ''}}">{{isBossDefeated ? 'ğŸ« ' : 'ğŸ§'}}</view>
        <view class="battle-meta">
          <text class="battle-name {{isBossDefeated ? 'text-dim' : 'text-red'}}">{{currentBossSkill.nickname}}</text>
          <view class="hp-bar red">
            <view class="hp-fill" style="width: {{isBossDefeated ? 0 : 100}}%; background-color: {{isBossDefeated ? '#475569' : '#ef4444'}};"></view>
          </view>
        </view>
      </view>

      <text class="battle-vs">VS</text>

      <view class="battle-side reverse">
        <view class="battle-meta align-right">
          <text class="battle-name {{isBossDefeated ? 'text-green' : 'text-blue'}}">{{currentEmpSkill.nickname}}</text>
          <view class="hp-bar green">
            <view class="hp-fill" style="width: 100%;"></view>
          </view>
        </view>
        <view class="avatar {{isBossDefeated ? 'avatar-win' : ''}}">{{isBossDefeated ? 'ğŸ˜' : 'ğŸ§‘â€ğŸ’»'}}</view>
      </view>
    </view>

    <scroll-view class="chat" scroll-y="true" scroll-into-view="{{scrollIntoView}}">
      <view
        wx:if="{{turnState === 'loop' || turnState === 'casting' || turnState === 'result_display' || turnState === 'player_atk' || turnState === 'boss_satisfied'}}"
        class="bubble-row left"
      >
        <view class="bubble boss {{isBossAngry ? 'shake-crazy' : ''}}">
          <text class="bubble-title text-red">{{currentBossSkill.nickname}}</text>
          <text class="bubble-text">â€œ{{bossAttackText}}â€</text>
        </view>
      </view>

      <view
        wx:if="{{turnState === 'result_display' || turnState === 'player_atk' || turnState === 'boss_satisfied'}}"
        class="bubble-row right"
      >
        <view class="bubble emp">
          <text class="bubble-title text-muted">{{currentEmpSkill.nickname}}</text>
          <view wx:if="{{currentEmpSkill.resultType === 'text'}}" class="bubble-text italic">â€œ{{empResultText}}â€</view>
          <view wx:else class="file-card">
            <view class="file-icon">{{currentEmpSkill.iconEmoji}}</view>
            <view class="file-info">
              <text class="file-title">{{currentEmpSkill.resultTitle}}</text>
              <text class="file-desc">{{currentEmpSkill.resultDesc}}</text>
            </view>
          </view>
        </view>
      </view>

      <view wx:if="{{isBossDefeated}}" class="bubble-row left">
        <view class="bubble win">
          <text class="bubble-title text-green">{{currentBossSkill.nickname}} (å·²å®‰æŠš)</text>
          <text class="bubble-text">â€œ{{bossSatisfiedText}}â€</text>
        </view>
      </view>

      <view wx:if="{{isSatisfiedTypingDone}}" class="victory">
        <view class="victory-card">
          <text class="victory-icon">ğŸ†</text>
          <text class="victory-title pixel-zh-title">å¯¹çº¿å¤§èƒœåˆ©!</text>
          <text class="victory-desc">åˆšæ‰åŒ–è§£å±æœºçš„ç¥å™¨æ˜¯ {{currentEmpSkill.brand}}ã€‚</text>
          <button class="victory-btn" bindtap="handleLearnMore">
            <text class="btn-icon">ğŸš€</text>
            <text>å»å­¦ä¹  {{currentEmpSkill.brand}}</text>
            <text class="btn-icon">â†—ï¸</text>
          </button>
          <button class="victory-link" bindtap="goSelect">æŒ‘æˆ˜ä¸‹ä¸€å…³</button>
        </view>
      </view>

      <view id="scroll-anchor"></view>
    </scroll-view>

    <view class="bottom-bar">
      <button
        class="cast-btn {{turnState === 'loop' ? 'cast-active' : 'cast-disabled'}}"
        bindtap="handleStartCast"
        disabled="{{turnState !== 'loop'}}"
      >
        <text class="btn-icon">{{currentEmpSkill.iconEmoji}}</text>
        <text>{{empSkillShortName}}</text>
      </button>
    </view>

    <view wx:if="{{turnState === 'casting'}}" class="overlay">
      <view class="modal" style="border-color: {{currentEmpSkill.brandColor}};">
        <view class="modal-header" style="background-color: {{currentEmpSkill.brandColor}}20; border-color: {{currentEmpSkill.brandColor}}40;">
          <view class="modal-title">
            <text class="brand-icon">{{currentEmpSkill.brandIconEmoji}}</text>
            <text>{{currentEmpSkill.brand}} AI Engine</text>
          </view>
          <view class="window-dots">
            <view class="dot red"></view>
            <view class="dot green"></view>
          </view>
        </view>

        <view class="modal-body">
          <view class="modal-top">
            <view class="modal-meta">
              <text class="modal-label">Process</text>
              <text class="modal-title-text" style="color: {{currentEmpSkill.brandColor}};">{{currentEmpSkill.techTitle}}</text>
            </view>
            <view class="modal-step">{{castStepIndex + 1}}/{{currentEmpSkill.castSteps.length}}</view>
          </view>

          <view class="modal-content">
            <view class="cast-text" style="color: {{currentEmpSkill.brandColor}};">
              {{currentCastStepText}}
            </view>
          </view>

          <view class="modal-footer">
            <view wx:if="{{!isCastingDone}}" class="cast-progress">
              <text class="cast-step">{{currentCastStepText}}</text>
              <view class="cast-dots">
                <view
                  wx:for="{{currentEmpSkill.castSteps}}"
                  wx:key="*this"
                  class="cast-dot {{castStepIndex >= index ? 'cast-dot-on' : 'cast-dot-off'}}"
                  style="background-color: {{castStepIndex >= index ? currentEmpSkill.brandColor : ''}};"
                ></view>
              </view>
            </view>
            <button
              wx:else
              class="fire-btn"
              style="background-color: {{currentEmpSkill.brandColor}};"
              bindtap="handleFire"
            >
              <text class="btn-icon">ğŸ“¨</text>
              <text>{{currentEmpSkill.actionBtn}}</text>
            </button>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>
